# .github/workflows/ci.yml
name: CI Pipeline Web

# O pipeline será executado em cada push e pull request para o branch 'main'.
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Trabalhos da aplicação.
jobs:
  build-test:
    runs-on: ubuntu-latest

    # Passos que serão executados.
    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Configurar Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Instalar dependências de teste
        # Instala o Jest.
        run: npm install jest

      - name: Executar testes de frontend
        # Executa os testes JavaScript com o Jest.
        run: npx jest


      # Etapa de Implantação Contínua (CD)
      - name: Configurar Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Inicializar Terraform
        id: init
        run: terraform init

      - name: Planejar a implantação
        id: plan
        run: terraform plan

      - name: Aplicar a infraestrutura simulada
        id: apply
        run: terraform apply -auto-approve

      - name: Exibir a URL do site implantado
        run: |
          echo "Site implantado com sucesso no caminho: $(terraform output site_url)"